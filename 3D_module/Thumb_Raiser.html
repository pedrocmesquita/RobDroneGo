<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Basic Thumb Raiser</title>
    <style>

        #building-container {
            position: absolute;
            left: .5vw;
            top: .5vh;
            color: white;
        }

        #container {
            position: absolute;
            left: 50.0vw;
            top: 50.0vh;
            z-index: 1;
            font-family: Arial, sans-serif;
        }

        body {
            margin: 0;
        }

        #elevator-container {
            position: absolute;
            left: .5vw;
            top: 10vh;
            color: white;
        }

        #automatic-container {
            position: absolute;
            left: .5vw;
            top: 20vh;
            color: white;
        }
        #automatic {
            background-color: #70707070;
            color: white;
            border: 1px solid black;
            padding: 8px;
            font-family: sans-serif, "Arial Hebrew";
            font-size: 1.5vmin;
        }

        #elevator {
            background-color: #70707070;
            color: white;
            border: 1px solid black;
            padding: 8px;
            font-family: sans-serif, "Arial Hebrew";
            font-size: 1.5vmin;
        }

        #elevator-container button {
            background-color: #70707070;
            color: white;
            border: 1px solid black;
            padding: 8px;
            font-family: Arial, sans-serif;
            font-size: 1.5vmin;
            margin-top: 8px;
        }

        #parent {
            position: absolute;
            left: 50.0vw;
        }

        #views-panel {
            position: absolute;
            left: -50.0vmin;
            top: 1vh;
            z-index: 1;
            width: 100.0vmin;
            text-align: center;
            font-family: Arial, sans-serif;
            font-size: 1.5vmin;
            color: white;
        }

        #help-panel {
            position: absolute;
            left: -50.0vmin;
            top: 20vh;
            z-index: 1;
            width: 100.0vmin;
            font-family: Arial, sans-serif;
            font-size: 1.5vmin;
            color: white;
        }

        #subwindows-panel {
            position: absolute;
            left: -49.0vw;
            bottom: -81.0vh;
            z-index: 1;
            width: 100.0vmin;
            font-family: Arial, sans-serif;
            font-size: 1.5vmin;
            color: white;
        }

        #tooltip {
            background-color: #fff;
            border: 1px solid #000;
            padding: 8px;
            border-radius: 4px;
            /* outros estilos conforme necessário */
        }


        table {
            margin-left: auto;
            margin-right: auto;
            border: 1px solid black;
        }

        table.views {
            background-color: #70707070;
            text-align: right;
        }

        table.help {
            width: 50vmin;
            background-color: #70707050;
        }

        table.subwindows {
            position: absolute;
            background-color: #70707070;
            text-align: right;
        }

        th,
        td {
            overflow: hidden;
            border: 1px solid black;
        }

        a {
            color: white;
        }

        #view,
        #projection {
            width: 18ch;
            font-size: 1.5vmin;
        }

        #horizontal,
        #vertical,
        #distance,
        #zoom {
            width: 10ch;
            font-size: 1.5vmin;
        }

        #reset,
        #reset-all {
            width: 16ch;
            font-size: 1.5vmin;
        }

        input:invalid {
            background-color: pink;
        }

        canvas {
            display: block;
        }
    </style>

</head>

<body>
<div id="tooltip" style="position: absolute; pointer-events: none;"></div>

    <script type="module">

        import * as THREE from "three";
        import Orientation from "./orientation.js";
        import ThumbRaiser from "./thumb_raiser.js";

        let thumbRaiser;

        function initialize() {
            // Create the game
            thumbRaiser = new ThumbRaiser(
              {}, // General Parameters
              { scale: new THREE.Vector3(1.0, 0.5, 1.0) }, // Maze parameters
              {}, // Player parameters
              { ambientLight: { intensity: 0.1 }, pointLight1: { intensity: 50.0, distance: 20.0, position: new THREE.Vector3(-3.5, 10.0, 2.5) }, pointLight2: { intensity: 50.0, distance: 20.0, position: new THREE.Vector3(3.5, 10.0, -2.5) } }, // Lights parameters
              {}, // Fog parameters
              { view: "fixed", multipleViewsViewport: new THREE.Vector4(0.0, 1.0, 0.45, 0.5) }, // Fixed view camera parameters
              { view: "first-person", multipleViewsViewport: new THREE.Vector4(1.0, 1.0, 0.55, 0.5), initialOrientation: new Orientation(0.0, -10.0), initialDistance: 2.0, distanceMin: 1.0, distanceMax: 4.0 }, // First-person view camera parameters
              { view: "third-person", multipleViewsViewport: new THREE.Vector4(0.0, 0.0, 0.55, 0.5), initialOrientation: new Orientation(0.0, -20.0), initialDistance: 2.0, distanceMin: 1.0, distanceMax: 4.0 }, // Third-person view camera parameters
              { view: "top", multipleViewsViewport: new THREE.Vector4(1.0, 0.0, 0.45, 0.5), initialOrientation: new Orientation(0.0, -90.0), initialDistance: 4.0, distanceMin: 1.0, distanceMax: 16.0 }, // Top view camera parameters
              { view: "mini-map", multipleViewsViewport: new THREE.Vector4(0.99, 0.02, 0.3, 0.3), initialOrientation: new Orientation(180.0, -90.0), initialZoom: 0.64 } // Mini-msp view camera parameters
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            // Update the game
            thumbRaiser.update();
        }

        initialize();
        animate();

        const urlParams = new URLSearchParams(window.location.search);
        const selectedBuilding = urlParams.get('buildingId');
        const selectedFloor = urlParams.get('floorId');

        console.log('Selected Building ID:', selectedBuilding);
        console.log('Selected Floor ID:', selectedFloor);

        displaySelectors(selectedBuilding, selectedFloor);


        window.addEventListener("message", (event) => {
            if (event.data.type === "SHOW_MENU") {
                //console.log("SHOW_MENU");

                const urlParams = new URLSearchParams(window.location.search);
                const selectedBuilding = urlParams.get('buildingId');
                const selectedFloor = urlParams.get('floorId');

                elevatorMenu(selectedBuilding, selectedFloor);
            }
        });


        let roomsN = [];
        let connectionsN = [];
        let elevatorsN = [];


        function getBuildingsFromBackend() {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'http://localhost:4000/api/3d/buildings');
                xhr.onload = () => resolve(JSON.parse(xhr.responseText));
                xhr.onerror = () => reject(xhr.statusText);
                console.log(xhr.responseText);
                xhr.send();
            });
        }

        function createJsonOnBackend(floorId) {
            return new Promise((resolve, reject) => {
                console.log('floorId:', floorId);
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'http://localhost:4000/api/3d/json/' + floorId);
                xhr.onload = () => {
                    console.log(xhr.responseText);
                    resolve(JSON.parse(xhr.responseText));
                };
                xhr.onerror = () => reject(xhr.statusText);
                xhr.send();
            });
        }


        async function displaySelectors(selectedBuilding, selectedFloor) {
            try {
                // Get the buildings from the backend
                console.log('Getting buildings from backend...')
                const buildings = await getBuildingsFromBackend();
                console.log('Buildings:', buildings);

                const oldBuilding = selectedBuilding;
                const oldFloor = selectedFloor;

                const buildingSelect = document.getElementById('building');
                buildingSelect.innerHTML = '';
                buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.buildingId;
                    option.text = building.buildingId + ': ' + building.buildingName;
                    option.selected = building.buildingId === selectedBuilding;
                    buildingSelect.appendChild(option);
                });

                let currentFloor = selectedFloor;

                buildingSelect.addEventListener('change', async () => {
                    const selectedBuildingId = buildingSelect.value;
                    const selectedBuilding = buildings.find(building => building.buildingId === selectedBuildingId);
                    const floors = selectedBuilding.floors;
                    console.log('Floors:', floors);

                    const floorSelect = document.getElementById('floor');
                    floorSelect.innerHTML = '';
                    floors.forEach(floor => {
                        const option = document.createElement('option');
                        option.value = floor.floorId;
                        option.text = `Floor ${floor.floorNumber}: ${floor.floorDescription}`;
                        option.selected = floor.floorId === selectedFloor;
                        floorSelect.appendChild(option);
                    });

                    currentFloor = floorSelect.value;
                });

                // Create a button that calls the goToBuilding function when clicked
                const goButton = document.createElement('button');
                goButton.innerText = 'Go';
                goButton.addEventListener('click', goToBuilding);

                const autoButton = document.createElement('button');
                autoButton.innerText = 'Auto Travel';
                autoButton.addEventListener('click', () => thumbRaiser.moveRobot(oldBuildingId,oldFloorId,buildings));

                // Create a home button that redirects to the home page
                const homeButton = document.createElement('button');
                homeButton.innerText = 'Home';
                homeButton.addEventListener('click', () => {
                    window.open('http://localhost:4200/home', '_blank');
                });

                // Create a button that starts an automatic path
                const urlParams = new URLSearchParams(window.location.search);
                const oldBuildingId = urlParams.get('buildingId');
                const oldFloorId = urlParams.get('floorId');


                // Append the button to the building-container div
                const container = document.getElementById('building-container');
                container.appendChild(goButton);
                container.appendChild(homeButton);
                container.appendChild(autoButton);

                // Trigger the change event to populate the floor select element
                buildingSelect.dispatchEvent(new Event('change'));
            } catch (error) {
                console.error('Error displaying selectors:', error);
            }
        }

        async function goToBuilding() {
            const buildingId = document.getElementById("building").value;
            const floorId = document.getElementById('floor').value;


            if (!buildingId || !floorId) {
                alert("Select a valid building and floor option");
                return;
            }

            console.log('FloorId:', floorId);

            await createJsonOnBackend(floorId);

            //let url = `http://127.0.0.1:5500/Thumb_Raiser.html`;
            let url = `http://127.0.0.1:5500/Thumb_Raiser.html?buildingId=${encodeURIComponent(buildingId)}&floorId=${encodeURIComponent(floorId)}`;

            const response = await fetch(url);
            if (response.status === 200) {
                // If the status is 200, the file exists. Redirect to the new URL
                window.location.href = url;
            } else if (response.status === 404) {
                // If the status is 404, the file does not exist. Show an alert message
                alert("The selected building and floor do not exist");
            }
        }

        async function elevatorMenu(selectedBuilding, selectedFloor){
            const buildingId = selectedBuilding;
            const floorId = selectedFloor;
            console.log('FloorId:', floorId);

            const buildings = await getBuildingsFromBackend();

            // Compare buildingId and floorId to the buildings array
            const building = buildings.find(building => building.buildingId === buildingId);

            // Loop through the floors array
            const floors = building.floors;
            const floor = floors.find(floor => floor.floorId === floorId);

            // Loop through the elevators array
            const elevators = floor.elevators;
            console.log('Elevators:', elevators);

            // Create a select element for the floors
            const elevatorSelect = document.createElement('select');
            elevatorSelect.id = 'elevator';
            floors.forEach(floor => {
                const option = document.createElement('option');
                option.value = floor.floorId;
                option.text = `Floor ${floor.floorNumber}: ${floor.floorDescription}`;
                elevatorSelect.appendChild(option);
            });

            // Create a button that calls the goToElevator function when clicked
            const goButton = document.createElement('button');
            goButton.innerText = 'Go';
            goButton.addEventListener('click', goToElevator);

            // Append the select element and the button to the elevator-container
            const container = document.getElementById('elevator-container');
            container.innerHTML = ''; // Clear the container
            container.appendChild(elevatorSelect);
            container.appendChild(goButton);
        }



        async function goToFloor(floorToId) {
            const urlParams = new URLSearchParams(window.location.search);
            const buildingFromId = urlParams.get('buildingId');
            const floorFromId = urlParams.get('floorId');

            let obstacleCoordinates = await requestData(buildingFromId, floorFromId);
            //let obstacles = parseObstacleData(obstacleCoordinates);
            console.log("VAMOSSSSSSS: ", obstacleCoordinates)


            console.log('Este é o piso de destino:', floorToId);
        }

        async function requestData(buildingId, floorId) {
            const url = 'http://localhost:4000/api/buildings/';
            const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6Ijg4NjFhNGI0LTU4ZDktNGE4ZC1hZGU0LTAyNzgzZGU4YmVlYyIsImVtYWlsIjoibWNAZ21haWwuY29tIiwicm9sZSI6IjRlZThkYjQ0LWRmZGUtNDcxMi1hZjQ0LTkzMjE0M2JiNzk5NCIsImZpcnN0TmFtZSI6Ik1hcnRhIiwibGFzdE5hbWUiOiJDYW1wb3MiLCJleHAiOjE3MDg5ODY3NjYuODEyLCJpYXQiOjE3MDM4MDI3NjZ9.5BYoDCPWivsxc6vnMG0yJtSg4CyoAusMEf3QG790v_E';

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const jsonData = await response.json();
                return processMazeData(jsonData, buildingId, floorId); // Return the processed data
            } catch (error) {
                console.error('Error fetching data:', error);
                return null; // Return null in case of an error
            }
        }



        function processMazeData(jsonData, buildingId, floorId) {
            const building = jsonData.find(b => b.buildingId === buildingId);
            if (!building) {
                console.error(`Building with ID ${buildingId} not found.`);
                return [];
            }

            const floor = building.floors.find(f => f.floorId === floorId);
            if (!floor) {
                console.error(`Floor with ID ${floorId} not found in building ${buildingId}.`);
                return [];
            }

            let combinedData = [];

            // Combine rooms data
            floor.rooms.forEach(room => {
                combinedData.push({ x: room.originCoordinateX, y: room.originCoordinateY });
                combinedData.push({ x: room.destinationCoordinateX, y: room.destinationCoordinateY });
            });

            // Combine connections data
            floor.connections.forEach(connection => {
                combinedData.push({ x: connection.locationX, y: connection.locationY });
            });

            // Combine elevators data
            floor.elevators.forEach(elevator => {
                combinedData.push({ x: elevator.locationX, y: elevator.locationY });
            });

            return combinedData;
        }



        async function goToElevator() {
            const buildingId = document.getElementById("building").value;
            const floorId = document.getElementById('elevator').value; // Changed from 'elevator' to 'floor'

            if (!buildingId || !floorId) {
                alert("Select a valid building and floor option");
                return;
            }

            console.log('FloorId:', floorId);

            await createJsonOnBackend(floorId);

            let url = `http://127.0.0.1:5500/Thumb_Raiser.html?buildingId=${encodeURIComponent(buildingId)}&floorId=${encodeURIComponent(floorId)}`;
            const response = await fetch(url);
            if (response.status === 200) {
                // If the status is 200, the file exists. Redirect to the new URL
                window.location.href = url;
            } else if (response.status === 404) {
                // If the status is 404, the file does not exist. Show an alert message
                alert("The selected building and floor do not exist");
            }
        }


    </script>
    <div id="building-container">
        <select id="building"></select>
        <select id="floor"></select>
    </div>

    <div id="elevator-container">
        <div id="elevator"></div>
    </div>

    <div id="parent">
        <div id="views-panel">
            <table class="views">
                <tr>
                    <td>
                        <label>View:</label>
                        <select id="view">
                            <option value="fixed">Fixed</option>
                            <option value="first">First-person</option>
                            <option value="third">Third-person</option>
                            <option value="top">Top</option>
                        </select>
                    </td>
                    <td>
                        <label>Orientation (h):</label>
                        <input type="number" id="horizontal" required>
                    </td>
                    <td>
                        <label>Orientation (v):</label>
                        <input type="number" id="vertical" required>
                    </td>
                    <td>
                        <input type="button" id="reset" value="Reset view">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Projection:</label>
                        <select id="projection">
                            <option value="perspective">Perspective</option>
                            <option value="orthographic">Orthographic</option>
                        </select>
                    </td>
                    <td>
                        <label>Distance:</label>
                        <input type="number" id="distance" required>
                    </td>
                    <td>
                        <label>Zoom:</label>
                        <input type="number" id="zoom" required>
                    </td>
                    <td>
                        <input type="button" id="reset-all" value="Reset all views">
                    </td>
                </tr>
            </table>
        </div>
        <div id="help-panel">
            <table class="help" id="help-table">
                <tr>
                    <th colspan="2" style="font-size: 3.0vmin">
                        Help
                    </th>
                </tr>
                <tr>
                    <th colspan="2" style="text-align: left">Select active view</th>
                </tr>
                <tr>
                    <td></td>
                    <td>Fixed view</td>
                </tr>
                <tr>
                    <td></td>
                    <td>First-person view</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Third-person view</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Top view</td>
                </tr>
                <tr>
                    <th colspan="2" style="text-align: left">Toggle view mode</th>
                </tr>
                <tr>
                    <td></td>
                    <td>Single-view mode / multiple-views mode</td>
                </tr>
                <tr>
                    <th colspan="2" style="text-align: left">Display / hide subwindows</th>
                </tr>
                <tr>
                    <td></td>
                    <td>User interface</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Mini-map</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Help</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Statistics</td>
                </tr>
                <tr>
                    <th colspan="2" style="text-align: left">Move character</th>
                </tr>
                <tr>
                    <td></td>
                    <td>Walk / run (modifier key)</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Turn left slowly / quickly</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Turn right slowly / quickly</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Walk / run backward</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Walk / run forward</td>
                </tr>
                <tr>
                    <th colspan="2" style="text-align: left">Emote character</th>
                </tr>
                <tr>
                    <td></td>
                    <td>Jump</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Yes</td>
                </tr>
                <tr>
                    <td></td>
                    <td>No</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Wave</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Punch</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Thumbs up</td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align: right"></td>
                </tr>
            </table>
        </div>
        <div id="subwindows-panel">
            <table class="subwindows">
                <tr>
                    <td>
                        <label>Multiple views:</label>
                        <input type="checkbox" id="multiple-views">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>User interface:</label>
                        <input type="checkbox" id="user-interface">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Mini-map:</label>
                        <input type="checkbox" id="mini-map">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Help:</label>
                        <input type="checkbox" id="help">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Statistics:</label>
                        <input type="checkbox" id="statistics">
                    </td>
                </tr>

            </table>
        </div>
    </div>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "../three.js-master/build/three.module.js",
                "three/addons/": "../three.js-master/examples/jsm/"
            }
        }
    </script>
    <script src="https://threejs.org/build/three.js"></script>
    <script>
        /*document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById('moveRobotButton').addEventListener('click', moveRobot);
        });*/
    </script>


    <script src="../lodash/lodash.js"></script>

</body>

</html>
